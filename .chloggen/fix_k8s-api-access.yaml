# One of 'breaking', 'deprecation', 'new_component', 'enhancement', 'bug_fix'
change_type: bug_fix

# The name of the component, or a single word describing the area of concern, (e.g. tempostack, tempomonolithic, github action)
component: tempostack

# A brief description of the change. Surround your text with quotes ("") if it needs to start with a backtick (`).
note: "NetworkPolicies now dynamically discover Kubernetes API server endpoints and ports instead of hardcoding port 6443"

# One or more tracking issues related to the change
issues: [1295]

# (Optional) One or more lines of additional information to render under the primary note.
# These lines will be padded with 2 spaces and then inserted directly into the document.
# Use pipe (|) for multiline entries.
subtext: |
  This fix resolves connectivity issues on managed Kubernetes services (e.g., Amazon EKS, Google GKE)
  that expose the Kubernetes API server on non-standard ports like 443 instead of the default 6443.

  ## What Changed

  The operator now automatically discovers the actual Kubernetes API server endpoints by querying the
  `kubernetes` EndpointSlice in the `default` namespace at reconcile time. This provides:

  - **Dynamic port detection**: Works with port 443 (EKS, some GKE configs), 6443 (standard K8s), or custom ports
  - **Specific IP restrictions**: When available, creates /32 CIDR rules for each control plane node IP
  - **Fallback**: Falls back to 0.0.0.0/0 with discovered port if EndpointSlice lookup fails

  ## Example

  On an EKS cluster with 3 control plane nodes, the operator now generates:

  ```yaml
  spec:
    egress:
    - ports:
      - protocol: TCP
        port: 443  # Discovered from EndpointSlice
      to:
      - ipBlock:
          cidr: 100.105.216.2/32
      - ipBlock:
          cidr: 100.109.70.105/32
      - ipBlock:
          cidr: 100.114.146.103/32
  ```

  No configuration changes are required. The operator automatically adapts to cluster's API server configuration.
