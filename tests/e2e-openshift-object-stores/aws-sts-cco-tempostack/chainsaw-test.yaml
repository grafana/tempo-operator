apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: aws-sts-tempostack-cco
  
  labels:
    type: aws-sts-cco
spec:
  # We need to run this test serially cause the operator is restarted after patching the operator subscription with ROLEARN
  concurrent: false
  description: Test TempoStack support for AWS S3 using STS and operator env config feature. This test is meant to be run from OpenShift CI as it depends on the credentials from CI.
  namespace: chainsaw-awscco-tempo
  steps:
  - name: Create AWS S3 bucket, IAM policy and role required for STS
    try:
    - script:
        timeout: 2m
        content: ./aws-sts-s3-create.sh tmcco chainsaw-awscco-tempo
    - assert:
        file: aws-sts-s3-create-assert.yaml
  - name: Verify operator env config feature
    try:
    - command:
        entrypoint: oc
        args:
        - get
        - pods
        - -A
        - -l control-plane=controller-manager
        - -l app.kubernetes.io/name=tempo-operator
        - -o
        - jsonpath={.items[0].metadata.namespace}
        outputs:
        - name: TEMPO_NAMESPACE
          value: ($stdout)
    - script:
        env:
        - name: TEMPO_NAMESPACE
          value: ($TEMPO_NAMESPACE)
        content: |
          # Verify the LEADER_ELECTION_RESOURCE_NAME env var is set in the deployment
          oc get deployment tempo-operator-controller -n "$TEMPO_NAMESPACE" -o jsonpath='{.spec.template.spec.containers[0].env[?(@.name=="LEADER_ELECTION_RESOURCE_NAME")].value}' | grep -q "tempo-operator-leader-aws-sts-test"
    - assert:
        file: env-config-assert.yaml
  - name: Install TempoStack
    try:
    - apply:
        file: install-tempostack.yaml
    - assert:
        file: install-tempostack-assert.yaml
  - name: Wait for the TempoStack to be ready
    try:
    - script:
        timeout: 5m
        content: oc get --namespace chainsaw-awscco-tempo tempo tmcco -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' | grep True
  - name: Generate traces
    try:
    - apply:
        file: generate-traces.yaml
    - assert:
        file: generate-traces-assert.yaml
  - name: Verify traces
    try:
    - apply:
        file: verify-traces.yaml
    - assert:
        file: verify-traces-assert.yaml
    cleanup:
    - script:
        timeout: 2m
        content: ./aws-sts-s3-delete.sh tmcco chainsaw-awscco-tempo
