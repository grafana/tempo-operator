---
apiVersion: v1
# Do not assert on data because cookieSecret is randomly generated by the operator
#data:
kind: Secret
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
type: Opaque
---
apiVersion: v1
data:
  rbac.yaml: ""
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  annotations:
    service.beta.openshift.io/inject-cabundle: "true"
  name: tempo-simplest-gateway-cabundle
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
---
apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  annotations:
    serviceaccounts.openshift.io/oauth-redirectreference.dev: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"tempo-simplest-gateway"}}'
    serviceaccounts.openshift.io/oauth-redirectreference.prod: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"tempo-simplest-gateway"}}'
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
rules:
  - apiGroups:
      - authentication.k8s.io
    resources:
      - tokenreviews
    verbs:
      - create
  - apiGroups:
      - authorization.k8s.io
    resources:
      - subjectaccessreviews
    verbs:
      - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tempo-simplest-gateway
subjects:
  - kind: ServiceAccount
    name: tempo-simplest-gateway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
  - apiVersion: tempo.grafana.com/v1alpha1
    blockOwnerDeletion: true
    controller: true
    kind: TempoStack
    name: simplest
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: gateway
      app.kubernetes.io/instance: simplest
      app.kubernetes.io/managed-by: tempo-operator
      app.kubernetes.io/name: tempo
  template:
    metadata:
      labels:
        app.kubernetes.io/component: gateway
        app.kubernetes.io/instance: simplest
        app.kubernetes.io/managed-by: tempo-operator
        app.kubernetes.io/name: tempo
    spec:
      containers:
      - args:
        - --traces.tenant-header=x-scope-orgid
        - --web.listen=0.0.0.0:8080
        - --web.internal.listen=0.0.0.0:8081
        - --traces.write.endpoint=tempo-simplest-distributor.chainsaw-multitenancy.svc.cluster.local:4317
        - --traces.tempo.endpoint=https://tempo-simplest-query-frontend.chainsaw-multitenancy.svc.cluster.local:3200
        - --grpc.listen=0.0.0.0:8090
        - --rbac.config=/etc/tempo-gateway/cm/rbac.yaml
        - --tenants.config=/etc/tempo-gateway/secret/tenants.yaml
        - --log.level=info
        - --tls.internal.server.key-file=/var/run/tls/server/tls.key
        - --tls.internal.server.cert-file=/var/run/tls/server/tls.crt
        - --traces.tls.key-file=/var/run/tls/server/tls.key
        - --traces.tls.cert-file=/var/run/tls/server/tls.crt
        - --traces.tls.ca-file=/var/run/ca/service-ca.crt
        - --tls.server.cert-file=/etc/tempo-gateway/serving-certs/tls.crt
        - --tls.server.key-file=/etc/tempo-gateway/serving-certs/tls.key
        - --tls.healthchecks.server-ca-file=/etc/tempo-gateway/cabundle/service-ca.crt
        - --tls.healthchecks.server-name=tempo-simplest-gateway.chainsaw-multitenancy.svc.cluster.local
        - --web.healthchecks.url=https://localhost:8080
        - --traces.read.endpoint=https://tempo-simplest-query-frontend.chainsaw-multitenancy.svc.cluster.local:16686
        livenessProbe:
          failureThreshold: 10
          httpGet:
            path: /live
            port: 8081
            scheme: HTTPS
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 2
        name: tempo-gateway
        ports:
        - containerPort: 8090
          name: grpc-public
          protocol: TCP
        - containerPort: 8081
          name: internal
          protocol: TCP
        - containerPort: 8080
          name: public
          protocol: TCP
        readinessProbe:
          failureThreshold: 12
          httpGet:
            path: /ready
            port: 8081
            scheme: HTTPS
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 120m
            memory: "107374184"
          requests:
            cpu: 36m
            memory: "32212256"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/tempo-gateway/cm
          name: rbac
          readOnly: true
        - mountPath: /etc/tempo-gateway/secret/tenants.yaml
          name: tenant
          readOnly: true
          subPath: tenants.yaml
        - mountPath: /var/run/ca
          name: tempo-simplest-ca-bundle
        - mountPath: /var/run/tls/server
          name: tempo-simplest-gateway-mtls
        - mountPath: /etc/tempo-gateway/serving-certs
          name: serving-certs
          readOnly: true
        - mountPath: /etc/tempo-gateway/cabundle
          name: cabundle
          readOnly: true
      - args:
        - --log.level=warn
        - --opa.admin-groups=system:cluster-admins,cluster-admin,dedicated-admin
        - --web.listen=:8082
        - --web.internal.listen=:8083
        - --web.healthchecks.url=http://localhost:8082
        - --opa.package=tempostack
        - --openshift.mappings=dev=tempo.grafana.com
        - --openshift.mappings=prod=tempo.grafana.com
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 10
          httpGet:
            path: /live
            port: 8083
            scheme: HTTP
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 2
        name: opa
        ports:
        - containerPort: 8082
          name: public
          protocol: TCP
        - containerPort: 8083
          name: opa-metrics
          protocol: TCP
        readinessProbe:
          failureThreshold: 12
          httpGet:
            path: /ready
            port: 8083
            scheme: HTTP
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      serviceAccount: tempo-simplest-gateway
      serviceAccountName: tempo-simplest-gateway
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: rbac.yaml
            path: rbac.yaml
          name: tempo-simplest-gateway
        name: rbac
      - name: tenant
        secret:
          defaultMode: 420
          items:
          - key: tenants.yaml
            path: tenants.yaml
          secretName: tempo-simplest-gateway
      - configMap:
          defaultMode: 420
          name: tempo-simplest-ca-bundle
        name: tempo-simplest-ca-bundle
      - name: tempo-simplest-gateway-mtls
        secret:
          defaultMode: 420
          secretName: tempo-simplest-gateway-mtls
      - name: serving-certs
        secret:
          defaultMode: 420
          secretName: tempo-simplest-gateway-tls
      - configMap:
          defaultMode: 420
          name: tempo-simplest-gateway-cabundle
        name: cabundle
status:
  readyReplicas: 1
  replicas: 1
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
spec:
  port:
    targetPort: public
  tls:
    termination: passthrough
  to:
    kind: Service
    name: tempo-simplest-gateway
    weight: 100
  wildcardPolicy: None
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.beta.openshift.io/serving-cert-secret-name: tempo-simplest-gateway-tls
  labels:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  name: tempo-simplest-gateway
  namespace: chainsaw-multitenancy
  ownerReferences:
    - apiVersion: tempo.grafana.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: TempoStack
      name: simplest
spec:
  ports:
    - name: grpc-public
      port: 8090
      protocol: TCP
      targetPort: 8090
    - name: internal
      port: 8081
      protocol: TCP
      targetPort: 8081
    - name: public
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app.kubernetes.io/component: gateway
    app.kubernetes.io/instance: simplest
    app.kubernetes.io/managed-by: tempo-operator
    app.kubernetes.io/name: tempo
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo-simplest-compactor
  namespace: chainsaw-multitenancy
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo-simplest-distributor
  namespace: chainsaw-multitenancy
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo-simplest-querier
  namespace: chainsaw-multitenancy
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo-simplest-query-frontend
  namespace: chainsaw-multitenancy
status:
  readyReplicas: 1
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tempo-simplest-ingester
  namespace: chainsaw-multitenancy
status:
  readyReplicas: 1
