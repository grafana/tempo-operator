apiVersion: batch/v1
kind: Job
metadata:
  name: verify-traces
spec:
  template:
    spec:
      containers:
      - name: verify-traces
        image: registry.gitlab.com/gitlab-ci-utils/curl-jq:1.1.0
        command:
        - /bin/bash
        - -eux
        - -c
        args:
        - |
          namespace=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
          curl \
            -sS -G \
            --cert /var/run/tls/server/tls.crt \
            --key /var/run/tls/server/tls.key \
            --cacert /var/run/ca/service-ca.crt \
            https://tempo-simplest-query-frontend.${namespace}.svc:3200/api/search \
            --data-urlencode "q={}" \
            | tee /tmp/tempo.out
          num_traces=$(jq ".traces | length" /tmp/tempo.out)
          if [[ "$num_traces" -ne 10 ]]; then
            echo && echo "The Tempo API returned $num_traces instead of 10 traces."
            exit 1
          fi

          curl -sS -G http://tempo-simplest-query-frontend:16686/api/traces --data-urlencode "service=telemetrygen" | tee /tmp/jaeger.out
          num_traces=$(jq ".data | length" /tmp/jaeger.out)
          if [[ "$num_traces" -ne 10 ]]; then
            echo && echo "The Jaeger API returned $num_traces instead of 10 traces."
            exit 1
          fi
        volumeMounts:
        - name: tempo-simplest-ca-bundle
          mountPath: /var/run/ca
        - name: tempo-simplest-gateway-mtls
          mountPath: /var/run/tls/server
      volumes:
      - name: tempo-simplest-ca-bundle
        configMap:
          name: tempo-simplest-ca-bundle
          defaultMode: 420
      - name: tempo-simplest-gateway-mtls
        secret:
          secretName: tempo-simplest-gateway-mtls
          defaultMode: 420
      restartPolicy: Never
