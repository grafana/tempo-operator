# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: tshirt-size-pico
spec:
  steps:
  - name: step-00
    try:
    - apply:
        file: 00-install-storage.yaml
    - assert:
        file: 00-assert.yaml
  - name: step-01
    try:
    - apply:
        file: 01-install-tempo.yaml
    - assert:
        file: 01-assert.yaml
  - name: step-02
    try:
    - script:
        timeout: 60s
        content: |
          # Verify ingester has correct resources from pico size
          INGESTER_CPU=$(kubectl get deployment tempo-pico-ingester -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].resources.requests.cpu}')
          INGESTER_MEM=$(kubectl get deployment tempo-pico-ingester -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].resources.requests.memory}')

          echo "Ingester CPU: $INGESTER_CPU"
          echo "Ingester Memory: $INGESTER_MEM"

          # pico size should have 500m CPU and 3Gi memory for ingester
          if [ "$INGESTER_CPU" != "500m" ]; then
            echo "ERROR: Expected ingester CPU 500m, got $INGESTER_CPU"
            exit 1
          fi

          if [ "$INGESTER_MEM" != "3Gi" ]; then
            echo "ERROR: Expected ingester memory 3Gi, got $INGESTER_MEM"
            exit 1
          fi

          echo "Ingester resources verified successfully"
  - name: step-03
    try:
    - script:
        timeout: 60s
        content: |
          # Verify distributor has correct resources from pico size
          DISTRIBUTOR_CPU=$(kubectl get deployment tempo-pico-distributor -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].resources.requests.cpu}')
          DISTRIBUTOR_MEM=$(kubectl get deployment tempo-pico-distributor -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].resources.requests.memory}')

          echo "Distributor CPU: $DISTRIBUTOR_CPU"
          echo "Distributor Memory: $DISTRIBUTOR_MEM"

          # pico size should have 500m CPU and 500Mi memory for distributor
          if [ "$DISTRIBUTOR_CPU" != "500m" ]; then
            echo "ERROR: Expected distributor CPU 500m, got $DISTRIBUTOR_CPU"
            exit 1
          fi

          if [ "$DISTRIBUTOR_MEM" != "500Mi" ]; then
            echo "ERROR: Expected distributor memory 500Mi, got $DISTRIBUTOR_MEM"
            exit 1
          fi

          echo "Distributor resources verified successfully"
  - name: step-04
    try:
    - script:
        timeout: 60s
        content: |
          # Verify replication factor is 2 (default for pico size)
          RF=$(kubectl get configmap tempo-pico -n $NAMESPACE -o jsonpath='{.data.tempo\.yaml}' | grep 'replication_factor:' | awk '{print $2}')

          echo "Replication Factor: $RF"

          if [ "$RF" != "2" ]; then
            echo "ERROR: Expected replication factor 2, got $RF"
            exit 1
          fi

          echo "Replication factor verified successfully"
