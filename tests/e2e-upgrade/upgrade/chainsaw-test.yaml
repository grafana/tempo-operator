# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  creationTimestamp: null
  name: upgrade
spec:
  steps:
  - name: step-00
    try:
    - apply:
        file: 00-install-storage.yaml
    - assert:
        file: 00-assert.yaml
  - name: step-10
    try:
    - apply:
        file: 10-setup-olm.yaml
  - name: step-20
    try:
    - apply:
        file: 20-install-old-operator.yaml
    - assert:
        file: 20-assert.yaml
  - catch:
    - script:
        content: kubectl apply -f tests/e2e-upgrade/upgrade/tempostack.yaml
    - script:
        content: kubectl delete tempo check-operator-ready
    name: step-21
    try: null
  - name: step-30
    try:
    - apply:
        file: 30-install-tempo.yaml
    - assert:
        file: 30-assert.yaml
  - catch:
    - script:
        content: /bin/sh -c "kubectl get --namespace $NAMESPACE tempo simplest -o
          jsonpath='{.status.conditions[?(@.type==\"Ready\")].status}' | grep True"
    name: step-31
    try: null
  - name: step-40
    try:
    - apply:
        file: 40-generate-traces.yaml
    - assert:
        file: 40-assert.yaml
  - name: step-50
    try:
    - apply:
        file: 50-verify-traces.yaml
    - assert:
        file: 50-assert.yaml
  - catch:
    - script:
        content: kubectl -n chainsaw-operator-upgrade get subscriptions.operators.coreos.com
          tempo -o yaml
    - podLogs:
        namespace: chainsaw-operator-upgrade
        selector: app.kubernetes.io/name=tempo-operator
        tail: 100
    name: step-60
    try:
    - apply:
        file: 60-upgrade-operator.yaml
    - assert:
        file: chainsaw-step-60-assert-1-1.yaml
    - assert:
        file: chainsaw-step-60-assert-1-2.yaml
    - assert:
        file: chainsaw-step-60-assert-1-3.yaml
  - catch:
    - script:
        content: /bin/sh -c "kubectl get --namespace $NAMESPACE tempo simplest -o
          jsonpath='{.status.conditions[?(@.type==\"Ready\")].status}' | grep True"
    - script:
        content: kubectl get --namespace $NAMESPACE deployment -o yaml
    - script:
        content: kubectl get --namespace $NAMESPACE statefulset -o yaml
    name: step-61
    try: null
  - name: step-70
    try:
    - apply:
        file: 70-verify-traces-after-upgrade.yaml
    - assert:
        file: 70-assert.yaml
